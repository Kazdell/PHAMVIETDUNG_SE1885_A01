@{
    ViewData["Title"] = "Staff Dashboard";
}

<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-3">Staff Dashboard</h1>
        <p class="text-muted">Real-time tracking of article engagement and system activity.</p>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Trending News Card -->
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up text-primary me-2"></i>Trending News
                    <span id="signalrStatus" class="badge bg-secondary ms-2" style="font-size: 0.7em;">Connecting...</span>
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadTrending()">Refresh</button>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush" id="trendingList">
                    <li class="list-group-item text-center text-muted">Loading trending news...</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Live Activity Feed -->
    <div class="col-md-6">
         <div class="card shadow-sm h-100">
             <div class="card-header bg-white">
                <h5 class="card-title mb-0"><i class="bi bi-activity text-success me-2"></i>Live Activity</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="activityFeed" style="max-height: 400px; overflow-y: auto;">
                    <!-- Live events will appear here -->
                    <div class="list-group-item text-muted small text-center">Waiting for events...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
     <div class="col-12">
         <div class="card shadow-sm">
             <div class="card-header bg-white d-flex justify-content-between align-items-center">
                 <h5 class="card-title mb-0">System Overview</h5>
                 <a href="@Url.Action("Export", "Staff")" class="btn btn-sm btn-success"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Export Excel</a>
             </div>
             <div class="card-body">
                  <!-- Row 2: Personal Stats -->
                  <h6 class="text-muted fw-bold text-uppercase small mb-3">My Performance (Session & All Time)</h6>
                  <input type="hidden" id="currentUserId" value="@Context.Session.GetString("AccountId")" />
                  
                  <div class="row text-center">
                      <div class="col-md-4">
                          <div class="card border-primary h-100">
                              <div class="card-body">
                                  <h2 class="display-5 fw-bold text-primary" id="myTotalArticles">@Model.MyTotalArticles</h2>
                                  <p class="text-muted mb-0 small">My Total Articles</p>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card border-success h-100">
                              <div class="card-body">
                                  <h5 class="fw-bold text-dark mb-1" id="myTopArticleTitle">-</h5>
                                  <p class="text-muted small mb-0">My Top Viewed (Session)</p>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card border-danger h-100">
                              <div class="card-body">
                                  <h2 class="display-5 fw-bold text-danger" id="myTopArticleViews">0</h2>
                                  <p class="text-muted mb-0 small">Live Readers (Top Article)</p>
                              </div>
                          </div>
                      </div>
                  </div>
             </div>
         </div>
     </div>
</div>

@section Scripts {
    <script>
        // Global System Data
        // Initialized from Server-side Model

        // Personal Session Data
        const currentUserId = document.getElementById("currentUserId").value;
        let myArticleViews = {}; // Map: ArticleId -> Count
        let myTopArticleId = null;

        // Init SignalR
        const dashboardConnection = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:5000/hubs/admindashboard")
            .withAutomaticReconnect([0, 2000, 5000, 10000, 30000]) // Retry immediately, then at 2s, 5s, 10s, 30s
            .configureLogging(signalR.LogLevel.Warning)
            .build();

        // Listen for Article View
        dashboardConnection.on("ReceiveArticleView", function (data) {
            // Check for both camelCase and PascalCase
            const articleId = data.articleId || data.ArticleId;
            const authorId = data.authorId || data.AuthorId;
            const articleTitle = data.title || data.Title || `Article #${articleId}`; // Use Title if available

            // Global View Counter (Session)
            let globalViewsEl = document.getElementById("totalViews");
            if (globalViewsEl) {
                let current = parseInt(globalViewsEl.innerText) || 0;
                globalViewsEl.innerText = current + 1;
            }

            // Personal Logic
            // Ensure strict string comparison
            console.log(`[SignalR] Msg Author: ${authorId}, Current User: ${currentUserId}`);
            
            if (String(authorId) === String(currentUserId)) {
                // Increment view for this article
                if (!myArticleViews[articleId]) {
                    myArticleViews[articleId] = 0;
                }
                myArticleViews[articleId]++;
                
                console.log(`[SignalR] Updating Personal Stats. Article ${articleId} views: ${myArticleViews[articleId]}`);

                // Update Top Article Logic
                updateTopArticle(articleId, articleTitle);
                
                // Add to Activity Feed
                addActivityLog(`<span class="badge bg-info">VIEW</span> Someone viewed: <strong>${articleTitle}</strong>`);
            } else {
                 console.log(`[SignalR] Author mismatch. Ignoring personal stats.`);
            }
        });

        // Listen for New Article
        dashboardConnection.on("ReceiveNewArticle", function (data) {
            const title = data.title || data.Title || "New Article";
            const authorId = data.authorId || data.AuthorId;
            const articleId = data.articleId || data.ArticleId;

            // Global Article Counter
            let globalArtsEl = document.getElementById("totalArticles");
            if (globalArtsEl) {
                let current = parseInt(globalArtsEl.innerText) || 0;
                globalArtsEl.innerText = current + 1;
            }

            // Personal Logic
            // Ensure strict string comparison to avoid type mismatch (int vs string)
            if (String(authorId) === String(currentUserId)) {
                let myArtsEl = document.getElementById("myTotalArticles");
                if (myArtsEl) {
                    let current = parseInt(myArtsEl.innerText) || 0;
                    myArtsEl.innerText = current + 1;
                }
                addActivityLog(`<span class="badge bg-success">NEW</span> You posted: <strong>${title}</strong>`);
            } else {
                 addActivityLog(`<span class="badge bg-secondary">SYSTEM</span> New article: <strong>${title}</strong>`);
            }
             
             // Refresh Trending
             loadTrending(); 
        });

        function updateTopArticle(articleId, articleTitle) {
            // Check if this article is now the top
            let currentTopViews = myTopArticleId ? myArticleViews[myTopArticleId] : 0;
            let thisArticleViews = myArticleViews[articleId];

            if (thisArticleViews > currentTopViews) {
                myTopArticleId = articleId;
                document.getElementById("myTopArticleViews").innerText = thisArticleViews;
                document.getElementById("myTopArticleTitle").innerText = articleTitle || `Article #${articleId}`;
            } else if (articleId === myTopArticleId) {
                // Just update the count
                 document.getElementById("myTopArticleViews").innerText = thisArticleViews;
            }
        }

        // Connection Lifecycle Handlers
        dashboardConnection.onreconnecting(error => {
            updateStatus("Reconnecting...", "bg-warning text-dark");
        });

        dashboardConnection.onreconnected(connectionId => {
            updateStatus("Connected", "bg-success");
            console.log("SignalR Reconnected. Id: " + connectionId);
        });

        dashboardConnection.onclose(error => {
            updateStatus("Disconnected", "bg-danger");
            console.error("SignalR Closed permanently.", error);
            addActivityLog(`<span class="text-danger">Disconnected from Real-time Stream.</span>`);
            // withAutomaticReconnect handles retries, onclose is only called after all retries exhausted
        });

        function updateStatus(text, badgeClass) {
            const el = document.getElementById("signalrStatus");
            if (el) {
                el.innerText = text;
                el.className = `badge ms-2 ${badgeClass} animate__animated animate__fadeIn`;
            }
        }

        async function startConnection() {
            // Prevent duplicate start attempts
            if (dashboardConnection.state !== signalR.HubConnectionState.Disconnected) {
                console.log("SignalR: Connection not in Disconnected state, skipping start.");
                return;
            }
            try {
                await dashboardConnection.start();
                updateStatus("Connected", "bg-success");
                console.log("Successfully connected to SignalR Hub: /hubs/admindashboard");
                addActivityLog("Connected to Real-time Stream.");
            } catch (err) {
                updateStatus("Error", "bg-danger");
                console.error("SignalR Connection Error:", err.toString());
                addActivityLog(`<span class="text-danger">Error connecting to Real-time Stream.</span>`);
                // Only retry if not already reconnecting (withAutomaticReconnect handles reconnects)
                if (dashboardConnection.state === signalR.HubConnectionState.Disconnected) {
                    setTimeout(startConnection, 5000);
                }
            }
        }

        // Start
        startConnection();

        function addActivityLog(html) {
             const feed = document.getElementById("activityFeed");
             const time = new Date().toLocaleTimeString();
             const item = `<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center animate__animated animate__fadeIn">
                             <span>${html}</span>
                             <small class="text-muted">${time}</small>
                           </div>`;
             
             if (feed.querySelector('.text-center')) {
                 feed.innerHTML = '';
             }

             feed.insertAdjacentHTML('afterbegin', item);
             
             if (feed.children.length > 20) {
                 feed.removeChild(feed.lastElementChild);
             }
        }

        function loadTrending() {
             const list = document.getElementById("trendingList");
             list.innerHTML = '<li class="list-group-item text-center text-muted"><span class="spinner-border spinner-border-sm"></span> Refreshing...</li>';

            fetch('/Staff/GetTrendingNews')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log("Trending News Data Received:", data);
                    list.innerHTML = '';
                    if (!data || data.length === 0) {
                        list.innerHTML = '<li class="list-group-item text-center text-muted">No data available.</li>';
                        return;
                    }

                    data.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        const title = item.title || item.Title || item.newsTitle || item.Headline || "No Title";
                        const views = item.viewCount ?? item.ViewCount ?? 0;
                        li.innerHTML = `
                             <div>
                                <span class="fw-bold me-2 text-muted">#${index + 1}</span>
                                <span class="fw-semibold">${title}</span>
                             </div>
                             <span class="badge bg-light text-dark border"><i class="bi bi-eye"></i> ${views}</span>
                        `;
                        list.appendChild(li);
                    });
                })
                .catch(err => {
                    console.error("Failed to load trending news:", err);
                    list.innerHTML = '<li class="list-group-item text-center text-danger">Failed to load trending news.</li>';
                });
        }

        // Initial Load
        document.addEventListener("DOMContentLoaded", function() {
            loadTrending();
        });

    </script>
}
